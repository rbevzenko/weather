<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ñ‹</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg-primary:    #0d0d14;
      --bg-card:       #16161f;
      --border:        #252535;
      --text-1:        #e2e8f0;
      --text-2:        #8892a4;
      --blue:          #3b82f6;
      --green:         #22c55e;
      --orange:        #f97316;
      --red:           #ef4444;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-1);
      min-height: 100vh;
      padding: 32px 16px 48px;
    }

    /* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    header {
      text-align: center;
      margin-bottom: 36px;
    }

    header h1 {
      font-size: clamp(1.5rem, 4vw, 2.2rem);
      font-weight: 800;
      letter-spacing: -0.5px;
      background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 14px;
    }

    .header-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 14px;
      flex-wrap: wrap;
    }

    #lastUpdated {
      font-size: 0.82rem;
      color: var(--text-2);
    }

    #refreshBtn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 7px 16px;
      background: rgba(96,165,250,.12);
      border: 1px solid rgba(96,165,250,.3);
      border-radius: 8px;
      color: #60a5fa;
      font-size: 0.82rem;
      cursor: pointer;
      transition: background .2s, transform .15s;
    }
    #refreshBtn:hover  { background: rgba(96,165,250,.22); transform: translateY(-1px); }
    #refreshBtn:active { transform: translateY(0); }
    #refreshBtn:disabled { opacity: .5; cursor: not-allowed; transform: none; }

    .spin-icon { display: inline-block; }
    #refreshBtn.busy .spin-icon { animation: spin .7s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ ERROR BANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #errorBanner {
      display: none;
      max-width: 900px;
      margin: 0 auto 24px;
      padding: 14px 20px;
      background: rgba(239,68,68,.1);
      border: 1px solid rgba(239,68,68,.3);
      border-radius: 12px;
      color: #fca5a5;
      font-size: .85rem;
      text-align: center;
    }
    #errorBanner.show { display: block; }

    /* â”€â”€ GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      max-width: 1100px;
      margin: 0 auto;
    }
    @media (max-width: 860px) {
      .grid { grid-template-columns: 1fr; max-width: 460px; }
    }

    /* â”€â”€ CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card {
      position: relative;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 24px;
      overflow: hidden;
      transition: transform .25s, box-shadow .25s, border-color .4s;
      box-shadow: 0 4px 20px rgba(0,0,0,.35);
    }
    .card:hover { transform: translateY(-5px); box-shadow: 0 10px 36px rgba(0,0,0,.5); }

    /* top accent bar */
    .card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: var(--accent, var(--green));
      border-radius: 20px 20px 0 0;
      transition: background .4s;
    }

    /* subtle glow under the bar */
    .card::after {
      content: '';
      position: absolute;
      top: 0; left: 10%; right: 10%;
      height: 60px;
      background: radial-gradient(ellipse at 50% 0%, var(--accent, var(--green)) 0%, transparent 70%);
      opacity: .07;
      transition: background .4s;
      pointer-events: none;
    }

    /* temperature-driven accent classes */
    .cold   { --accent: var(--blue);   border-color: rgba(59,130,246,.25); }
    .cool   { --accent: var(--green);  border-color: rgba(34,197, 94,.25); }
    .warm   { --accent: var(--orange); border-color: rgba(249,115, 22,.25); }
    .hot    { --accent: var(--red);    border-color: rgba(239, 68, 68,.25); }

    /* loading overlay */
    .overlay {
      position: absolute;
      inset: 0;
      background: rgba(13,13,20,.75);
      backdrop-filter: blur(3px);
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 20px;
      opacity: 0;
      pointer-events: none;
      transition: opacity .25s;
      z-index: 10;
    }
    .card.loading .overlay { opacity: 1; pointer-events: auto; }

    .loader {
      width: 38px; height: 38px;
      border: 3px solid rgba(255,255,255,.1);
      border-top-color: #60a5fa;
      border-radius: 50%;
      animation: spin .75s linear infinite;
    }

    /* â”€â”€ CARD CONTENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card-head {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 18px;
    }

    .city-name {
      font-size: 1.15rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 7px;
    }
    .flag { font-size: 1.3rem; }

    .local-time {
      font-size: 0.75rem;
      color: var(--text-2);
      margin-top: 5px;
      font-variant-numeric: tabular-nums;
    }

    .weather-emoji {
      font-size: 2.8rem;
      line-height: 1;
      filter: drop-shadow(0 2px 6px rgba(0,0,0,.4));
    }

    /* temperature */
    .temp-row { display: flex; align-items: baseline; gap: 2px; margin-bottom: 4px; }
    .temp-main { font-size: 3.4rem; font-weight: 800; letter-spacing: -2px; line-height: 1; }
    .temp-unit { font-size: 1.5rem; font-weight: 400; }
    .feels-like { font-size: .8rem; color: var(--text-2); margin-bottom: 10px; }
    .weather-desc { font-size: .95rem; font-weight: 500; color: var(--text-2); margin-bottom: 18px; }

    /* stats */
    .stats {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      margin-bottom: 16px;
    }
    .stat {
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.05);
      border-radius: 10px;
      padding: 9px 10px;
    }
    .stat-label { font-size: .65rem; color: var(--text-2); text-transform: uppercase; letter-spacing: .4px; margin-bottom: 4px; }
    .stat-val   { font-size: .88rem; font-weight: 600; }

    /* sun times */
    .sun-row {
      display: flex;
      gap: 18px;
      padding-top: 14px;
      border-top: 1px solid var(--border);
    }
    .sun-item { font-size: .82rem; color: var(--text-2); display: flex; align-items: center; gap: 5px; }

    /* data fade-in on update */
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(6px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .updated { animation: fadeUp .4s ease; }

    /* â”€â”€ FOOTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    footer {
      text-align: center;
      margin-top: 44px;
      font-size: .78rem;
      color: var(--text-2);
    }
    footer a { color: #60a5fa; text-decoration: none; }
    footer a:hover { text-decoration: underline; }
  </style>
</head>
<body>

<header>
  <h1>ğŸŒ ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ñ‹</h1>
  <div class="header-controls">
    <span id="lastUpdated">ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…â€¦</span>
    <button id="refreshBtn" onclick="refreshAll()">
      <span class="spin-icon">â†»</span> ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑĞµĞ¹Ñ‡Ğ°Ñ
    </button>
  </div>
</header>

<div id="errorBanner">âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾ Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ğµ. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº Ğ¸Ğ½Ñ‚ĞµÑ€Ğ½ĞµÑ‚Ñƒ Ğ¸ Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ÑĞ½Ğ¾Ğ²Ğ°.</div>

<div class="grid">
  <!-- â”€â”€ Moscow â”€â”€ -->
  <div class="card loading" id="card-moscow">
    <div class="overlay"><div class="loader"></div></div>
    <div class="card-head">
      <div>
        <div class="city-name"><span class="flag">ğŸ‡·ğŸ‡º</span> ĞœĞ¾ÑĞºĞ²Ğ°</div>
        <div class="local-time" id="time-moscow">--:--:--</div>
      </div>
      <div class="weather-emoji" id="icon-moscow">â€¦</div>
    </div>
    <div class="temp-row">
      <span class="temp-main" id="temp-moscow">--</span>
      <span class="temp-unit">Â°C</span>
    </div>
    <div class="feels-like"  id="feels-moscow">ĞÑ‰ÑƒÑ‰Ğ°ĞµÑ‚ÑÑ ĞºĞ°Ğº --Â°C</div>
    <div class="weather-desc" id="desc-moscow">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°â€¦</div>
    <div class="stats">
      <div class="stat"><div class="stat-label">ğŸ’§ Ğ’Ğ»Ğ°Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ</div><div class="stat-val" id="hum-moscow">--%</div></div>
      <div class="stat"><div class="stat-label">ğŸ’¨ Ğ’ĞµÑ‚ĞµÑ€</div><div class="stat-val" id="wind-moscow">--</div></div>
      <div class="stat"><div class="stat-label">ğŸŒ¡ Ğ”Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ</div><div class="stat-val" id="pres-moscow">--</div></div>
    </div>
    <div class="sun-row">
      <div class="sun-item">ğŸŒ… <span id="rise-moscow">--:--</span></div>
      <div class="sun-item">ğŸŒ‡ <span id="set-moscow">--:--</span></div>
    </div>
  </div>

  <!-- â”€â”€ Famagusta â”€â”€ -->
  <div class="card loading" id="card-famagusta">
    <div class="overlay"><div class="loader"></div></div>
    <div class="card-head">
      <div>
        <div class="city-name"><span class="flag">ğŸ‡¨ğŸ‡¾</span> Ğ¤Ğ°Ğ¼Ğ°Ğ³ÑƒÑÑ‚Ğ°</div>
        <div class="local-time" id="time-famagusta">--:--:--</div>
      </div>
      <div class="weather-emoji" id="icon-famagusta">â€¦</div>
    </div>
    <div class="temp-row">
      <span class="temp-main" id="temp-famagusta">--</span>
      <span class="temp-unit">Â°C</span>
    </div>
    <div class="feels-like"  id="feels-famagusta">ĞÑ‰ÑƒÑ‰Ğ°ĞµÑ‚ÑÑ ĞºĞ°Ğº --Â°C</div>
    <div class="weather-desc" id="desc-famagusta">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°â€¦</div>
    <div class="stats">
      <div class="stat"><div class="stat-label">ğŸ’§ Ğ’Ğ»Ğ°Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ</div><div class="stat-val" id="hum-famagusta">--%</div></div>
      <div class="stat"><div class="stat-label">ğŸ’¨ Ğ’ĞµÑ‚ĞµÑ€</div><div class="stat-val" id="wind-famagusta">--</div></div>
      <div class="stat"><div class="stat-label">ğŸŒ¡ Ğ”Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ</div><div class="stat-val" id="pres-famagusta">--</div></div>
    </div>
    <div class="sun-row">
      <div class="sun-item">ğŸŒ… <span id="rise-famagusta">--:--</span></div>
      <div class="sun-item">ğŸŒ‡ <span id="set-famagusta">--:--</span></div>
    </div>
  </div>

  <!-- â”€â”€ Barcelona â”€â”€ -->
  <div class="card loading" id="card-barcelona">
    <div class="overlay"><div class="loader"></div></div>
    <div class="card-head">
      <div>
        <div class="city-name"><span class="flag">ğŸ‡ªğŸ‡¸</span> Ğ‘Ğ°Ñ€ÑĞµĞ»Ğ¾Ğ½Ğ°</div>
        <div class="local-time" id="time-barcelona">--:--:--</div>
      </div>
      <div class="weather-emoji" id="icon-barcelona">â€¦</div>
    </div>
    <div class="temp-row">
      <span class="temp-main" id="temp-barcelona">--</span>
      <span class="temp-unit">Â°C</span>
    </div>
    <div class="feels-like"  id="feels-barcelona">ĞÑ‰ÑƒÑ‰Ğ°ĞµÑ‚ÑÑ ĞºĞ°Ğº --Â°C</div>
    <div class="weather-desc" id="desc-barcelona">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°â€¦</div>
    <div class="stats">
      <div class="stat"><div class="stat-label">ğŸ’§ Ğ’Ğ»Ğ°Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ</div><div class="stat-val" id="hum-barcelona">--%</div></div>
      <div class="stat"><div class="stat-label">ğŸ’¨ Ğ’ĞµÑ‚ĞµÑ€</div><div class="stat-val" id="wind-barcelona">--</div></div>
      <div class="stat"><div class="stat-label">ğŸŒ¡ Ğ”Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ</div><div class="stat-val" id="pres-barcelona">--</div></div>
    </div>
    <div class="sun-row">
      <div class="sun-item">ğŸŒ… <span id="rise-barcelona">--:--</span></div>
      <div class="sun-item">ğŸŒ‡ <span id="set-barcelona">--:--</span></div>
    </div>
  </div>
</div>

<footer>
  Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ: <a href="https://open-meteo.com/" target="_blank" rel="noopener">Open-Meteo API</a>
  &nbsp;Â·&nbsp; ĞĞ²Ñ‚Ğ¾Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 10 Ğ¼Ğ¸Ğ½ÑƒÑ‚
</footer>

<script>
'use strict';

/* â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const CITIES = [
  { id: 'moscow',    name: 'ĞœĞ¾ÑĞºĞ²Ğ°',    lat: 55.7558, lon: 37.6173, tz: 'Europe/Moscow'  },
  { id: 'famagusta', name: 'Ğ¤Ğ°Ğ¼Ğ°Ğ³ÑƒÑÑ‚Ğ°', lat: 35.1174, lon: 33.9391, tz: 'Asia/Famagusta' },
  { id: 'barcelona', name: 'Ğ‘Ğ°Ñ€ÑĞµĞ»Ğ¾Ğ½Ğ°', lat: 41.3874, lon:  2.1686, tz: 'Europe/Madrid'  },
];

/* WMO weather-code â†’ Russian description + emoji */
const WMO = {
    0: ['Ğ¯ÑĞ½Ğ¾',                    'â˜€ï¸'],
    1: ['ĞŸÑ€ĞµĞ¸Ğ¼ÑƒÑ‰ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ ÑÑĞ½Ğ¾',    'ğŸŒ¤ï¸'],
    2: ['ĞŸĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ğ°Ñ Ğ¾Ğ±Ğ»Ğ°Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ',   'â›…'],
    3: ['ĞŸĞ°ÑĞ¼ÑƒÑ€Ğ½Ğ¾',                'â˜ï¸'],
   45: ['Ğ¢ÑƒĞ¼Ğ°Ğ½',                   'ğŸŒ«ï¸'],
   48: ['ĞÑĞµĞ´Ğ°ÑÑ‰Ğ°Ñ Ğ¸Ğ·Ğ¼Ğ¾Ñ€Ğ¾Ğ·ÑŒ',      'ğŸŒ«ï¸'],
   51: ['Ğ¡Ğ»Ğ°Ğ±Ğ°Ñ Ğ¼Ğ¾Ñ€Ğ¾ÑÑŒ',           'ğŸŒ¦ï¸'],
   53: ['Ğ£Ğ¼ĞµÑ€ĞµĞ½Ğ½Ğ°Ñ Ğ¼Ğ¾Ñ€Ğ¾ÑÑŒ',        'ğŸŒ¦ï¸'],
   55: ['Ğ¡Ğ¸Ğ»ÑŒĞ½Ğ°Ñ Ğ¼Ğ¾Ñ€Ğ¾ÑÑŒ',          'ğŸŒ§ï¸'],
   56: ['Ğ›ĞµĞ´ÑĞ½Ğ°Ñ Ğ¼Ğ¾Ñ€Ğ¾ÑÑŒ',          'ğŸŒ¨ï¸'],
   57: ['Ğ¡Ğ¸Ğ»ÑŒĞ½Ğ°Ñ Ğ»ĞµĞ´ÑĞ½Ğ°Ñ Ğ¼Ğ¾Ñ€Ğ¾ÑÑŒ',  'ğŸŒ¨ï¸'],
   61: ['Ğ¡Ğ»Ğ°Ğ±Ñ‹Ğ¹ Ğ´Ğ¾Ğ¶Ğ´ÑŒ',            'ğŸŒ§ï¸'],
   63: ['Ğ£Ğ¼ĞµÑ€ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ´Ğ¾Ğ¶Ğ´ÑŒ',         'ğŸŒ§ï¸'],
   65: ['Ğ¡Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ´Ğ¾Ğ¶Ğ´ÑŒ',           'ğŸŒ§ï¸'],
   66: ['Ğ›ĞµĞ´ÑĞ½Ğ¾Ğ¹ Ğ´Ğ¾Ğ¶Ğ´ÑŒ',           'ğŸŒ¨ï¸'],
   67: ['Ğ¡Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ»ĞµĞ´ÑĞ½Ğ¾Ğ¹ Ğ´Ğ¾Ğ¶Ğ´ÑŒ',   'ğŸŒ¨ï¸'],
   71: ['Ğ¡Ğ»Ğ°Ğ±Ñ‹Ğ¹ ÑĞ½ĞµĞ³Ğ¾Ğ¿Ğ°Ğ´',         'â„ï¸'],
   73: ['Ğ£Ğ¼ĞµÑ€ĞµĞ½Ğ½Ñ‹Ğ¹ ÑĞ½ĞµĞ³Ğ¾Ğ¿Ğ°Ğ´',      'â„ï¸'],
   75: ['Ğ¡Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑĞ½ĞµĞ³Ğ¾Ğ¿Ğ°Ğ´',        'ğŸŒ¨ï¸'],
   77: ['Ğ¡Ğ½ĞµĞ¶Ğ½Ğ°Ñ ĞºÑ€ÑƒĞ¿Ğ°',           'ğŸŒ¨ï¸'],
   80: ['Ğ¡Ğ»Ğ°Ğ±Ñ‹Ğ¹ Ğ»Ğ¸Ğ²ĞµĞ½ÑŒ',           'ğŸŒ¦ï¸'],
   81: ['Ğ£Ğ¼ĞµÑ€ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ»Ğ¸Ğ²ĞµĞ½ÑŒ',        'ğŸŒ§ï¸'],
   82: ['Ğ¡Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ»Ğ¸Ğ²ĞµĞ½ÑŒ',          'â›ˆï¸'],
   85: ['Ğ¡Ğ½ĞµĞ¶Ğ½Ñ‹Ğ¹ Ğ»Ğ¸Ğ²ĞµĞ½ÑŒ',          'ğŸŒ¨ï¸'],
   86: ['Ğ¡Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑĞ½ĞµĞ¶Ğ½Ñ‹Ğ¹ Ğ»Ğ¸Ğ²ĞµĞ½ÑŒ',  'ğŸŒ¨ï¸'],
   95: ['Ğ“Ñ€Ğ¾Ğ·Ğ°',                   'â›ˆï¸'],
   96: ['Ğ“Ñ€Ğ¾Ğ·Ğ° Ñ Ğ³Ñ€Ğ°Ğ´Ğ¾Ğ¼',          'â›ˆï¸'],
   99: ['Ğ“Ñ€Ğ¾Ğ·Ğ° Ñ ÑĞ¸Ğ»ÑŒĞ½Ñ‹Ğ¼ Ğ³Ñ€Ğ°Ğ´Ğ¾Ğ¼',  'â›ˆï¸'],
};

/* â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function wmoInfo(code) {
  return WMO[code] ?? ['ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾', 'ğŸŒ¡ï¸'];
}

function tempClass(t) {
  if (t <   0) return 'cold';
  if (t <  15) return 'cool';
  if (t <  30) return 'warm';
  return 'hot';
}

function fmtSign(n) {
  return n > 0 ? `+${n}` : String(n);
}

/* Extract "HH:MM" from API datetime string "YYYY-MM-DDTHH:MM" */
function sunTime(iso) {
  if (!iso) return '--:--';
  const t = iso.split('T')[1];
  return t ? t.slice(0, 5) : '--:--';
}

function localTime(tz) {
  return new Date().toLocaleTimeString('ru-RU', {
    hour: '2-digit', minute: '2-digit', second: '2-digit',
    timeZone: tz,
  });
}

/* hPa â†’ mm Hg */
function toMmHg(hpa) {
  return Math.round(hpa * 0.750062);
}

/* â”€â”€ FETCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function fetchCity(city) {
  const p = new URLSearchParams({
    latitude:  city.lat,
    longitude: city.lon,
    current: [
      'temperature_2m',
      'apparent_temperature',
      'relative_humidity_2m',
      'weather_code',
      'wind_speed_10m',
      'surface_pressure',
    ].join(','),
    daily: 'sunrise,sunset',
    timezone: city.tz,
    forecast_days: 1,
  });
  const res = await fetch(`https://api.open-meteo.com/v1/forecast?${p}`);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return res.json();
}

/* â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderCard(city, data) {
  const c  = data.current;
  const d  = data.daily;
  const id = city.id;

  const temp    = Math.round(c.temperature_2m);
  const feels   = Math.round(c.apparent_temperature);
  const hum     = c.relative_humidity_2m;
  const wind    = Math.round(c.wind_speed_10m);
  const pres    = toMmHg(c.surface_pressure);
  const code    = c.weather_code;
  const [desc, icon] = wmoInfo(code);

  /* card element */
  const card = document.getElementById(`card-${id}`);
  card.classList.remove('loading', 'cold', 'cool', 'warm', 'hot');
  card.classList.add(tempClass(temp));

  /* flash animation */
  const content = card.querySelectorAll(
    '.card-head, .temp-row, .feels-like, .weather-desc, .stats, .sun-row'
  );
  content.forEach(el => {
    el.classList.remove('updated');
    void el.offsetWidth;          // reflow to restart animation
    el.classList.add('updated');
  });

  /* fill data */
  document.getElementById(`icon-${id}`).textContent    = icon;
  document.getElementById(`temp-${id}`).textContent    = fmtSign(temp);
  document.getElementById(`feels-${id}`).textContent   = `ĞÑ‰ÑƒÑ‰Ğ°ĞµÑ‚ÑÑ ĞºĞ°Ğº ${fmtSign(feels)}Â°C`;
  document.getElementById(`desc-${id}`).textContent    = desc;
  document.getElementById(`hum-${id}`).textContent     = `${hum}%`;
  document.getElementById(`wind-${id}`).textContent    = `${wind} ĞºĞ¼/Ñ‡`;
  document.getElementById(`pres-${id}`).textContent    = `${pres} Ğ¼Ğ¼`;

  /* sunrise / sunset â€“ already in local tz from API */
  document.getElementById(`rise-${id}`).textContent = sunTime(d.sunrise?.[0]);
  document.getElementById(`set-${id}`).textContent  = sunTime(d.sunset?.[0]);
}

/* â”€â”€ CLOCKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function tickClocks() {
  CITIES.forEach(c => {
    const el = document.getElementById(`time-${c.id}`);
    if (el) el.textContent = localTime(c.tz);
  });
}

/* â”€â”€ REFRESH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function refreshAll() {
  const btn    = document.getElementById('refreshBtn');
  const banner = document.getElementById('errorBanner');

  banner.classList.remove('show');
  btn.classList.add('busy');
  btn.disabled = true;

  /* show loading overlay on every card */
  CITIES.forEach(c => document.getElementById(`card-${c.id}`).classList.add('loading'));

  let anyError = false;
  await Promise.allSettled(
    CITIES.map(async city => {
      try {
        const data = await fetchCity(city);
        renderCard(city, data);
      } catch (err) {
        console.error(`[${city.name}]`, err);
        anyError = true;
        /* keep the old data visible; just remove loading */
        document.getElementById(`card-${city.id}`).classList.remove('loading');
      }
    })
  );

  if (anyError) banner.classList.add('show');

  const now = new Date().toLocaleTimeString('ru-RU', {
    hour: '2-digit', minute: '2-digit', second: '2-digit',
  });
  document.getElementById('lastUpdated').textContent = `ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾: ${now}`;

  btn.classList.remove('busy');
  btn.disabled = false;
}

/* â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
tickClocks();
setInterval(tickClocks, 1000);

refreshAll();
setInterval(refreshAll, 10 * 60 * 1000);   /* auto-refresh every 10 min */
</script>
</body>
</html>
